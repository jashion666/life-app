<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>検針システム</title>
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
</head>
<script type="application/javascript">
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register(
            'service-worker.js',
            {scope: './'}
        ).then(function () {
            document.getElementById('status').innerHTML = 'successful';
        }).catch(function (error) {
            document.getElementById('status').innerHTML = error;
        });
    } else {
        document.getElementById('status').innerHTML = 'unavailable';
    }
    window.addEventListener('load', function (event) {
        navigator.serviceWorker.oncontrollerchange = function () {
            console.log('画面已经被更新');
        };
        if (!navigator.onLine) {
            $("#aa").attr("disabled", true);
            console.log('网络已断开');
        }
        window.addEventListener('offline', function () {
            console.log('网络已断开');
            $("#aa").attr("disabled", true);
        });
        window.addEventListener('online', function () {
            $("#aa").attr("disabled", false);
            console.log('网络已经恢复');
        })
    })
</script>
<body>
<p>Registration status: <strong id="status"></strong></p>

<div>
    <table border="1">
        <tbody id="tData">
        <tr>
            <th>番号</th>
            <th>氏名</th>
            <th>前回计算值</th>
            <th>今回计算值</th>
        </tr>
        </tbody>
    </table>
</div>
<input type="button" id="aa" value="同步" onclick="syncData()">
</body>

<script type="application/javascript">
    $(function () {
        loadAll();
    });

    function loadAll() {
        fetch("/test").then(result => {
            return result.json();
        }).then(ret => {
            renderingData(ret);
        }).catch(e => {
            console.log(e);
        })
    }

    function renderingData(ret) {
        let tr = $("#tData");
        ret.forEach(item => {
            tr.append("<tr>");
            tr.append("<td>" + item.homeCode + "</td>");
            tr.append("<td><a href='detail.html?homeCode=" + item.homeCode + "'>" + item.name + "</a></td>");
            tr.append("<td>" + item.lastTime + "</td>");
            tr.append("<td>" + item.thisTime + "</td>");
            tr.append("</tr>");
        })
    }

    function syncData() {
        caches.open("stale-1").then(function (cache) {
            cache.match("test").then(response => {
                return response.clone().json();
            }).then(result => {
                console.log(result);
                fetch("/sync-data", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(result)
                }).then(res => {
                    return res.json();
                }).then(ret => {
                    console.log(ret);
                    alert("同步成功")
                }).catch(e => {
                    console.log(e);
                })
            });
        })
    }
</script>

</html>